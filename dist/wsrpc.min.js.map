{"version":3,"sources":["wsrpc.es6.js"],"names":["logGroup","group","level","args","console","apply","this","groupEnd","log","WSRPC","DEBUG","arguments","trace","msg","TRACE","payload","JSON","parse","data","getAbsoluteWsUrl","url","test","window","location","host","length","Error","concat","scheme","protocol","port","path","replace","buildProxyMethodHandler","property","get","handler","childProperty","startsWith","newProperty","Proxy","target","thisArg","_toConsumableArray","Deferred","wrapper","func","self","done","error","_classCallCheck","resolve","reject","promise","Promise","isPending","readyState","Object","freeze","0","1","2","3","URL","createSocket","reconnect","callEvents","setTimeout","socket","id","exc","reconnectTimeout","tryCallEvent","event","e","hasOwnProperty","stack","evName","oneTimeEventStore","deferred","shift","i","eventStore","cur","handleCall","badPromise","routes","method","connectionNumber","then","result","send","stringify","asyncRoutes","params","promiseMock","handleError","store","handleResult","ws","WebSocket","rejectQueue","callQueue","callObj","key","onclose","err","public","state","serial","onerror","onopen","ev","onmessage","message","type","current","socketEventsListeners","exception","makeCall","push","undefined","eventId","socketStarted","onconnect","onchange","defer","call","proxy","addRoute","route","callback","isAsync","deleteRoute","addEventListener","removeEventListener","index","onEvent","destroy","close","stateCode","connect","addServerEventListener","callable","removeServerEventListener","splice","sendRaw","argsObj","info"],"mappings":"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","file":"wsrpc.min.js","sourcesContent":["class Deferred {\n\tconstructor() {\n\t\tconst self = this;\n\n\t\tself.resolve = null;\n\t\tself.reject = null;\n\t\tself.done = false;\n\n\t\tfunction wrapper(func) {\n\t\t\treturn function () {\n\t\t\t\tif (self.done) {\n\t\t\t\t\tconsole.error(new Error('Promise already done'));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tself.done = true;\n\t\t\t\treturn func.apply(this, arguments);\n\t\t\t}\n\t\t}\n\n\t\tself.promise = new Promise(\n\t\t\t(resolve, reject) => {\n\t\t\t\tself.resolve = wrapper(resolve);\n\t\t\t\tself.reject = wrapper(reject);\n\t\t\t}\n\t\t);\n\n\t\tself.promise.isPending = () => { return !self.done };\n\t\treturn self;\n\t}\n}\n\nfunction logGroup(group, level, args) {\n\tconsole.group(group);\n\tconsole[level].apply(this, args);\n\tconsole.groupEnd();\n}\n\nfunction log() {\n\tif (!WSRPC.DEBUG) return;\n\tlogGroup('WSRPC.DEBUG', 'trace', arguments);\n}\n\nfunction trace (msg) {\n\tif (!WSRPC.TRACE) return;\n\n\tlet payload = msg;\n\tif ('data' in msg) payload = JSON.parse(msg.data);\n\tlogGroup(\"WSRPC.TRACE\", 'trace', [payload]);\n}\n\nfunction getAbsoluteWsUrl(url) {\n\tif ((/^\\w+:\\/\\//).test(url)) return url;\n\tif (typeof window == 'undefined' && window.location.host.length < 1)\n\t\tthrow new Error(\n\t\t\t`Can not construct absolute URL from ${window.location}`\n\t\t);\n\tconst scheme = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n\tconst port = window.location.port === '' ? `:${window.location.port}` : '';\n\tconst host = window.location.host;\n\tconst path = url.replace(/^\\/+/gm, '');\n\treturn `${scheme}//${host}${port}/${path}`;\n}\n\nfunction buildProxyMethodHandler(property){\n  return {\n    get: (handler, childProperty) => {\n      if (childProperty.startsWith('_')) {\n        return handler[childProperty];\n      }\n      const newProperty = property ? `${property}.${childProperty}` : childProperty;\n      return new Proxy(\n        handler,\n        buildProxyMethodHandler(newProperty),\n      );\n    },\n    apply: function (target, thisArg, args) {\n      return target(property, ...args);\n    },\n  };\n}\n\nconst readyState = Object.freeze({\n\t0: 'CONNECTING',\n\t1: 'OPEN',\n\t2: 'CLOSING',\n\t3: 'CLOSED'\n});\n\nclass WSRPC {\n\tconstructor (URL, reconnectTimeout = 1000) {\n\t\tlet self = this;\n\n\t\tURL = getAbsoluteWsUrl(URL);\n\n\t\tself.id = 1;\n\t\tself.eventId = 0;\n\t\tself.socketStarted = false;\n\t\tself.eventStore = {\n\t\t\tonconnect: {},\n\t\t\tonerror: {},\n\t\t\tonclose: {},\n\t\t\tonchange: {}\n\t\t};\n\t\tself.connectionNumber = 0;\n\t\tself.oneTimeEventStore = {\n\t\t\tonconnect: [],\n\t\t\tonerror: [],\n\t\t\tonclose: [],\n\t\t\tonchange: []\n\t\t};\n\n\t\tself.callQueue = [];\n\n\t\tfunction createSocket() {\n\t\t\tlet ws = new WebSocket(URL);\n\n\t\t\tlet rejectQueue = function () {\n\t\t\t\tself.connectionNumber++; // rejects incoming calls\n\t\t\t\tlet deferred;\n\n\t\t\t\t//reject all pending calls\n\t\t\t\twhile (0 < self.callQueue.length) {\n\t\t\t\t\tlet callObj = self.callQueue.shift();\n\t\t\t\t\tdeferred = self.store[callObj.id];\n\t\t\t\t\tdelete self.store[callObj.id];\n\n\t\t\t\t\tif (deferred && deferred.promise.isPending()) {\n\t\t\t\t\t\tdeferred.reject('WebSocket error occurred');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// reject all from the store\n\t\t\t\tfor (let key in self.store) {\n\t\t\t\t\tif (!self.store.hasOwnProperty(key)) continue;\n\n\t\t\t\t\tdeferred = self.store[key];\n\t\t\t\t\tif (deferred && deferred.promise.isPending()) {\n\t\t\t\t\t\tdeferred.reject('WebSocket error occurred');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tfunction reconnect(callEvents) {\n\t\t\t\tsetTimeout(function () {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tself.socket = createSocket();\n\t\t\t\t\t\tself.id = 1;\n\t\t\t\t\t} catch (exc) {\n\t\t\t\t\t\tcallEvents('onerror', exc);\n\t\t\t\t\t\tdelete self.socket;\n\t\t\t\t\t\tconsole.error(exc);\n\t\t\t\t\t}\n\t\t\t\t}, reconnectTimeout);\n\t\t\t}\n\n\t\t\tws.onclose = function (err) {\n\t\t\t\tlog('ONCLOSE CALLED', 'STATE', self.public.state());\n\t\t\t\ttrace(err);\n\n\t\t\t\tfor (let serial in self.store) {\n\t\t\t\t\tif (!self.store.hasOwnProperty(serial)) continue;\n\t\t\t\t\tif (self.store[serial].hasOwnProperty('reject')) {\n\t\t\t\t\t\tself.store[serial].reject('Connection closed');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\trejectQueue();\n\t\t\t\tcallEvents('onclose', err);\n\t\t\t\tcallEvents('onchange', err);\n\t\t\t\treconnect(callEvents);\n\t\t\t};\n\n\t\t\tws.onerror = function (err) {\n\t\t\t\tlog('ONERROR CALLED', 'STATE', self.public.state());\n\t\t\t\ttrace(err);\n\n\t\t\t\trejectQueue();\n\t\t\t\tcallEvents('onerror', err);\n\t\t\t\tcallEvents('onchange', err);\n\n\t\t\t\tlog('WebSocket has been closed by error: ', err);\n\t\t\t};\n\n\t\t\tfunction tryCallEvent(func, event) {\n\t\t\t\ttry {\n\t\t\t\t\treturn func(event);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (e.hasOwnProperty('stack')) {\n\t\t\t\t\t\tlog(e.stack);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlog('Event function', func, 'raised unknown error:', e);\n\t\t\t\t\t}\n\t\t\t\t\tconsole.error(e);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction callEvents(evName, event) {\n\t\t\t\twhile (0 < self.oneTimeEventStore[evName].length) {\n\t\t\t\t\tlet deferred = self.oneTimeEventStore[evName].shift();\n\t\t\t\t\tif (deferred.hasOwnProperty('resolve') &&\n\t\t\t\t\t\tdeferred.promise.isPending()) deferred.resolve();\n\t\t\t\t}\n\n\t\t\t\tfor (let i in self.eventStore[evName]) {\n\t\t\t\t\tif (!self.eventStore[evName].hasOwnProperty(i)) continue;\n\t\t\t\t\tlet cur = self.eventStore[evName][i];\n\t\t\t\t\ttryCallEvent(cur, event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tws.onopen = function (ev) {\n\t\t\t\tlog('ONOPEN CALLED', 'STATE', self.public.state());\n\t\t\t\ttrace(ev);\n\n\t\t\t\twhile (0 < self.callQueue.length) {\n\t\t\t\t\t// noinspection JSUnresolvedFunction\n\t\t\t\t\tself.socket.send(JSON.stringify(self.callQueue.shift(), 0, 1));\n\t\t\t\t}\n\n\t\t\t\tcallEvents('onconnect', ev);\n\t\t\t\tcallEvents('onchange', ev);\n\t\t\t};\n\n\t\t\tfunction handleCall(self, data) {\n\t\t\t\tif (!self.routes.hasOwnProperty(data.method))\n\t\t\t\t\tthrow new Error('Route not found');\n\n\t\t\t\tlet connectionNumber = self.connectionNumber;\n\t\t\t\tlet deferred = new Deferred();\n\n\t\t\t\tdeferred.promise.then(\n\t\t\t\t\tfunction (result) {\n\t\t\t\t\t\tif (connectionNumber !== self.connectionNumber) return;\n\t\t\t\t\t\tself.socket.send(JSON.stringify({\n\t\t\t\t\t\t\tid: data.id,\n\t\t\t\t\t\t\tresult: result || null\n\t\t\t\t\t\t}));\n\t\t\t\t\t},\n\t\t\t\t\tfunction (error) {\n\t\t\t\t\t\tif (connectionNumber !== self.connectionNumber) return;\n\t\t\t\t\t\tself.socket.send(JSON.stringify({\n\t\t\t\t\t\t\tid: data.id,\n\t\t\t\t\t\t\terror: error || null\n\t\t\t\t\t\t}));\n\t\t\t\t\t}\n\t\t\t\t);\n\n\t\t\t\tlet func = self.routes[data.method];\n\n\t\t\t\tif (self.asyncRoutes[data.method])\n\t\t\t\t\treturn func.apply(deferred, [data.params]);\n\n\t\t\t\tfunction badPromise() {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\"You should register route with async flag.\"\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tlet promiseMock = {\n\t\t\t\t\tresolve: badPromise,\n\t\t\t\t\treject: badPromise,\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tdeferred.resolve(func.apply(promiseMock, [data.params]));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tdeferred.reject(e);\n\t\t\t\t\tconsole.error(e);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction handleError(self, data) {\n\t\t\t\tif (!self.store.hasOwnProperty(data.id))\n\t\t\t\t\treturn log('Unknown callback');\n\n\t\t\t\tlet deferred = self.store[data.id];\n\n\t\t\t\tif (typeof deferred === 'undefined')\n\t\t\t\t\treturn log('Confirmation without handler');\n\n\t\t\t\tdelete self.store[data.id];\n\t\t\t\tlog('REJECTING', data.error);\n\t\t\t\tdeferred.reject(data.error);\n\t\t\t}\n\n\t\t\tfunction handleResult(self, data) {\n\t\t\t\tlet deferred = self.store[data.id];\n\t\t\t\tif (typeof deferred === 'undefined')\n\t\t\t\t\treturn log('Confirmation without handler');\n\n\t\t\t\tdelete self.store[data.id];\n\n\t\t\t\tif (data.hasOwnProperty('result')) {\n\t\t\t\t\treturn deferred.resolve(data.result);\n\t\t\t\t}\n\t\t\t\treturn deferred.reject(data.error);\n\t\t\t}\n\n\t\t\tws.onmessage = function (message) {\n\t\t\t\tlog('ONMESSAGE CALLED', 'STATE', self.public.state());\n\t\t\t\ttrace(message);\n\n\t\t\t\tif (message.type !== 'message') return;\n\n\t\t\t\tlet data;\n\n\t\t\t\ttry {\n\t\t\t\t\tdata = JSON.parse(message.data);\n\t\t\t\t\tlog(data);\n\n\t\t\t\t\tif (!data.hasOwnProperty('id')) {\n\t\t\t\t\t\tlet current;\n\n\t\t\t\t\t\tconsole.group(\"Event received\");\n\t\t\t\t\t\tfor (let i = 0; i < self.socketEventsListeners.length; i++) {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tcurrent = self.socketEventsListeners[i];\n\t\t\t\t\t\t\t\tcurrent.apply(self.public, [data]);\n\t\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t\tconsole.error(e);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconsole.groupEnd();\n\t\t\t\t\t} else if (data.hasOwnProperty('method')) {\n\t\t\t\t\t\treturn handleCall(self, data);\n\t\t\t\t\t} else if (data.hasOwnProperty('error') && data.error === null) {\n\t\t\t\t\t\treturn handleError(self, data);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn handleResult(self, data);\n\t\t\t\t\t}\n\t\t\t\t} catch (exception) {\n\t\t\t\t\tlet err = {\n\t\t\t\t\t\terror: exception.message,\n\t\t\t\t\t\tresult: null,\n\t\t\t\t\t\tid: data ? data.id : null\n\t\t\t\t\t};\n\n\t\t\t\t\tself.socket.send(JSON.stringify(err));\n\t\t\t\t\tconsole.error(exception);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\treturn ws;\n\t\t}\n\n\t\tfunction makeCall(func, args, params) {\n\t\t\tself.id += 2;\n\t\t\tlet deferred = new Deferred();\n\n\t\t\tlet callObj = Object.freeze({\n\t\t\t\tid: self.id,\n\t\t\t\tmethod: func,\n\t\t\t\tparams: args\n\t\t\t});\n\n\t\t\tlet state = self.public.state();\n\n\t\t\tif (state === 'OPEN') {\n\t\t\t\tself.store[self.id] = deferred;\n\t\t\t\tself.socket.send(JSON.stringify(callObj));\n\t\t\t} else if (state === 'CONNECTING') {\n\t\t\t\tlog('SOCKET IS', state);\n\t\t\t\tself.store[self.id] = deferred;\n\t\t\t\tself.callQueue.push(callObj);\n\t\t\t} else {\n\t\t\t\tlog('SOCKET IS', state);\n\t\t\t\tif (params && params['noWait']) {\n\t\t\t\t\tdeferred.reject(`Socket is: ${state}`);\n\t\t\t\t} else {\n\t\t\t\t\tself.store[self.id] = deferred;\n\t\t\t\t\tself.callQueue.push(callObj);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn deferred.promise;\n\t\t}\n\n\t\tself.socketEventsListeners = [function (event) {console.log(event);}];\n\t\tself.asyncRoutes = {};\n\t\tself.routes = {};\n\t\tself.store = {};\n\t\tself.public = Object.freeze({\n            defer: function () {\n                return new Deferred();\n            },\n\t\t\tcall: function (func, args, params) {\n\t\t\t\treturn makeCall(func, args, params);\n\t\t\t},\n\t\t\tproxy: new Proxy(makeCall, buildProxyMethodHandler()),\n\t\t\taddRoute: function (route, callback, isAsync) {\n\t\t\t\tself.asyncRoutes[route] = isAsync || false;\n\t\t\t\tself.routes[route] = callback;\n\t\t\t},\n\t\t\tdeleteRoute: function (route) {\n\t\t\t\tdelete self.asyncRoutes[route];\n\t\t\t\treturn delete self.routes[route];\n\t\t\t},\n\t\t\taddEventListener: function (event, func) {\n\t\t\t\tlet eventId = self.eventId++;\n\t\t\t\tself.eventStore[event][eventId] = func;\n\t\t\t\treturn eventId;\n\t\t\t},\n\t\t\tremoveEventListener: function (event, index) {\n\t\t\t\tif (self.eventStore[event].hasOwnProperty(index)) {\n\t\t\t\t\tdelete self.eventStore[event][index];\n\t\t\t\t\treturn true;\n\t\t\t\t} else {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t},\n\t\t\tonEvent: function (event) {\n\t\t\t\tlet deferred = new Deferred();\n\t\t\t\tself.oneTimeEventStore[event].push(deferred);\n\t\t\t\treturn deferred.promise;\n\t\t\t},\n\t\t\tdestroy: function () {\n\t\t\t\treturn self.socket.close();\n\t\t\t},\n\t\t\tstate: function () {\n\t\t\t\treturn readyState[this.stateCode()];\n\t\t\t},\n\t\t\tstateCode: function () {\n\t\t\t\tif (self.socketStarted && self.socket)\n\t\t\t\t\treturn self.socket.readyState;\n\t\t\t\treturn 3;\n\t\t\t},\n\t\t\tconnect: function () {\n\t\t\t\tself.socketStarted = true;\n\t\t\t\tself.socket = createSocket();\n\t\t\t},\n\t\t\taddServerEventListener: function (callable) {\n\t\t\t\treturn self.socketEventsListeners.push(callable) - 1;\n\t\t\t},\n\t\t\tremoveServerEventListener: function (index) {\n\t\t\t    return self.socketEventsListeners.splice(index, 1).length;\n\t\t\t},\n            sendRaw: function (data) {\n                return self.socket.send(data);\n            }\n\t\t});\n\n\t\tself.public.addRoute('log', function (argsObj) {\n\t\t\tconsole.info(`Websocket sent: ${argsObj}`);\n\t\t});\n\n\t\tself.public.addRoute('ping', function (data) {\n\t\t\treturn data;\n\t\t});\n\n\t\treturn self.public;\n\t}\n}\n\nWSRPC.DEBUG = false;\nWSRPC.TRACE = false;\n\nexport default WSRPC;\n"]}